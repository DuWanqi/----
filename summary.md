# 《逃离后室：山屋惊魂》项目总结

## 项目概述
基于Three.js的3D俯视角恐怖探索游戏，玩家与AI队友在"后室"迷宫中逃生。

**技术栈**：TypeScript + Three.js + Vite，可选集成Google Gemini API

---

## 核心系统

### 1. 层级系统
- **Level 0 山屋**：黄色墙纸走廊风格，包含多种房间类型
- **Level 188 格子房间**：白色网格风格，NPC出现率高
- 通过紫色传送门在层级间跃迁

### 2. 房间类型
| 类型 | 特点 |
|------|------|
| BASIC | 黄色走廊，70%概率 |
| DANGER | 灰色管道间，20%，生成钥匙 |
| HUB | 蓝色枢纽，5%，必出杏仁水 |
| SECRET | 粉色派对房，5%，必出打火机+报纸 |
| PORTAL | 紫色传送门，探索6房后出现 |
| EXIT | 绿色出口，探索10房后出现 |
| GRID | Level 188专属白色网格房 |

### 3. 玩家系统
- **移动**：WASD/方向键，Shift奔跑（产生噪音）
- **精神值**：最大100，归零游戏结束
- **背包**：6格，按I打开，点击使用道具
- **交互**：Space拾取，E互动，F与队友对话，T与NPC对话，C合成

### 4. AI队友
| 类型 | 名称 | 特点 |
|------|------|------|
| PSYCHIC | 艾琳 | 紫色，预言性对话 |
| EXPLORER | 马克 | 绿色，务实建议 |
| HISTORIAN | 李博士 | 棕色，历史知识 |

- 自动跟随玩家（距离2单位）
- 信任度系统：≥60愿意分享线索
- 可使用Gemini API或固定对话

### 5. 敌对实体
| 实体 | 触发条件 | 伤害 | 应对方法 |
|------|----------|------|----------|
| 笑魇 | 噪音>30且无光 | 锁定5秒 | 保持安静+光源 |
| 窃皮者 | 靠近<2米 | 25 | 钥匙攻击，10秒后自动逃离 |
| 影怪 | 黑暗中出现 | 5/持续 | 光源驱散，火把效果5倍 |
| 派对客 | 缓慢靠近 | 50 | 远离避开 |

### 6. NPC系统
| 类型 | 初始好感度 | 可给道具 |
|------|------------|----------|
| 流浪者 | 50-70 | 杏仁水 |
| 收集者 | 30-50 | 杏仁水/电池/钥匙 |
| 学者 | 40-60 | 报纸/钥匙/打火机 |

- 好感度≥70可获得道具
- 支持AI对话或关键词匹配的固定对话
- 正面词（谢谢/帮助/朋友）提升好感度
- 负面词（滚/蠢/死）降低好感度

### 7. 道具系统
| 道具 | 效果 |
|------|------|
| 杏仁水 | 恢复30精神值 |
| 煤油灯 | 驱散影怪 |
| 电池 | 补充煤油灯 |
| 钥匙 | 攻击窃皮者（3米内） |
| 打火机+报纸 | 按C合成火把 |
| 火把 | 永久光源，5倍驱散影怪 |

---

## 文件结构
```
src/
├── main.ts              # 入口，初始化Three.js
├── game/
│   ├── MainScene.ts     # 主场景，游戏循环
│   ├── RoomGenerator.ts # 房间生成
│   └── types.ts         # 类型定义
├── entities/
│   ├── Player.ts        # 玩家
│   ├── Companion.ts     # AI队友
│   ├── Entity.ts        # 敌对实体（4种）
│   └── RoomNPC.ts       # 房间NPC
├── systems/
│   ├── AIService.ts     # AI对话服务
│   └── Logger.ts        # 日志
└── ui/
    └── GameUI.ts        # 全部UI组件
```

---

## 关键实现细节

### 输入处理修复
NPC对话和设置面板的输入框需要阻止事件传播，否则按键会被游戏捕获：
```typescript
inputEl.addEventListener('keydown', e => e.stopPropagation())
inputEl.addEventListener('keyup', e => e.stopPropagation())
inputEl.addEventListener('mousedown', e => e.stopPropagation())
```

关闭对话时重置所有按键状态：
```typescript
Object.keys(this.keys).forEach(key => { this.keys[key] = false })
```

### Gemini API集成
```typescript
// 端点
`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`

// NPC对话返回JSON格式
{ response: string, dispositionChange: number, shouldGiveItem: boolean }
```

### 窃皮者追逐逻辑
- 被玩家靠近后激活追逐
- 追逐10秒后自动逃离（缩小动画后消失）
- 玩家可用钥匙在3米内攻击消灭

### 火把效果
- 合成：打火机 + 报纸 → 火把
- 比煤油灯更亮（强度1.5 vs 1.0）
- 对影怪驱散速度5倍
- 影怪会主动逃离火把

---

## UI组件
- **HUD**：精神值条、队友状态、探索数、操作提示
- **背包**：6格物品栏，点击使用
- **对话框**：队友/NPC对话显示
- **教程**：7页可滚动教程，首次启动自动显示
- **暂停菜单**：继续/教程/返回主菜单
- **设置**：API Key输入、难度选择

---

## 游戏流程
1. 主菜单选择队友
2. 生成起始房间，进入游戏
3. 探索房间，收集道具，与NPC交流
4. 躲避/对抗实体，维持精神值
5. 探索6+房间后出现传送门（可跃迁层级）
6. 探索10+房间后出现出口
7. 找到出口胜利，精神值归零失败
